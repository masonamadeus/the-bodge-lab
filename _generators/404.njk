---
permalink: 404.html
layout: layout.njk
title: "Page Not Found (404)"
eleventyExcludeFromCollections: true
directory: false
download: false
---

<h1>Trying to find that page...</h1>

<p>This is The <em>Bodge</em> Lab, so things get moved around!</p>

<h3>Based on the URL you tried, were you looking for one of these?</h3>

<div id="smart-search-results">
  <p><i>Initializing...</i></p>
</div>

<div>
  <p>Keywords: "<i id="search-keywords"></i>"</p>
</div>

<hr>
<p>Or, you can try heading back to the <a href="/">homepage</a>.</p>

<script>
  // Unified 404 Logic: Shortlinks FIRST, then Search
  document.addEventListener('bodgelab:searchready', async () => {
    
    // --- Helpers ---
    function decodeSearchString(str) {
      if (!str) return '';
      try {
        str = decodeURIComponent(str);
      } catch (e) {}
      const textarea = document.createElement('textarea');
      textarea.innerHTML = str;
      return textarea.value;
    }

    const resultsContainer = document.getElementById('smart-search-results');
    const keywordsContainer = document.getElementById('search-keywords');
    const path = window.location.pathname;

    // --- Shortlink Check ---
    // If the URL starts with /s/, we try to resolve it first.
    if (path.startsWith('/s/')) {
      const uid = path.replace('/s/', '').replace(/\/$/, '');
      
      resultsContainer.innerHTML = '<p><i>Checking shortlinks...</i></p>';
      keywordsContainer.textContent = `Shortlink ID: ${uid}`;

      try {
        const response = await fetch('/shortlinks.json');
        if (response.ok) {
          const links = await response.json();
          if (links[uid]) {
            // SUCCESS: Redirect
            resultsContainer.innerHTML = `<p><i>Shortlink found! Redirecting...</i></p>`;
            window.location.replace(links[uid]);
            return; // Stop execution here
          }
        }
      } catch (e) {
        console.error("Shortlink lookup failed", e);
      }
      
      // If we are here, the shortlink failed.
      // We let the code fall through to the Search Logic, 
      // but we interpret the UID as the search term.
    }

    // --- STEP 2: Smart-ish Search Logic ---
    // We process the path to make it a readable search query
    const query = decodeSearchString(path)
        .replace(/^\/s\//, '') // Remove leading /s/ if it was a failed shortlink
        .replace(/[\/\-]/g, ' ') // Turn slashes/dashes to spaces
        .toLowerCase() // Prevent capital letters from getting cut off
        .replace(/[^a-z0-9\s]/g, ' ') // NOW this is safe (everything is lowercase)
        .trim();

    keywordsContainer.textContent = query;
    resultsContainer.innerHTML = '<p><i>Searching...</i></p>';

    // 1. Get Results
    const results = await window.BodgeLab.getResults(query);

    // 2. Smart Redirect (High Confidence Match)
    if (results.length === 1 && results[0].score > 5) { 
      const match = results[0];
      resultsContainer.innerHTML = `<p><i>Found a perfect match! Redirecting to: <a href="${match.url}">${match.title}</a></i></p>`;
      window.location.replace(match.url);
    } else {
      // 3. Render List
      window.BodgeLab.render(results, resultsContainer, query);
    }
  });
</script>