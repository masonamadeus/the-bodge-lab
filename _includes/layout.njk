<!DOCTYPE html>
<html lang="en">
    <head>
        {# --- Dynamic Favicon (Persistent + Editable) --- #}
        <script>
            (function () {
                const STORAGE_KEY = 'bodge-id-v1';
                const SIZE = 5;
                // 1. Try to load existing identity
                let identity = null;
                try {
                    identity = JSON.parse(localStorage.getItem(STORAGE_KEY));
                } catch (e) {}
                // 2. If no identity, GENESIS MODE (Random Generation)
                if (! identity) {
                    const hue = Math.floor(Math.random() * 360);
                    const grid = new Array(SIZE * SIZE).fill(null);
                    // Generate Mirrored Pattern
                    for (let x = 0; x < Math.ceil(SIZE / 2); x++) {
                        for (let y = 0; y < SIZE; y++) {
                            if (Math.random() > 0.5) {
                                const alpha = (Math.random() * 0.6 + 0.4).toFixed(2);
                                // We store: { o: opacity, c: customColor (optional) }
                                const pixel = {
                                    o: alpha
                                };
                                // Set Left
                                grid[y * SIZE + x] = pixel;
                                // Set Mirror
                                if (x < Math.floor(SIZE / 2)) {
                                    grid[y * SIZE + (SIZE - 1 - x)] = pixel;
                                }
                            }
                        }
                    }
                    identity = {
                        hue,
                        grid
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(identity));
                }
                // 3. Render SVG Define Theme Colors based on the stored Hue
                const cLight = `hsl(${
                    identity.hue
                }, 80%, 40%)`;
                const cDark = `hsl(${
                    identity.hue
                }, 80%, 70%)`;
                let rects = '';
                identity.grid.forEach((pixel, i) => {
                    if (!pixel) 
                        return;
                    
                    const x = i % SIZE;
                    const y = Math.floor(i / SIZE);
                    // If pixel has a custom color, use it. Otherwise use CSS var. We use a CSS class 'themable' to let the style block
                    // handle standard pixels
                    const fillAttr = pixel.c
                        ? `fill="${
                        pixel.c
                    }"` : `class="themable"`;
                    rects += `<rect x="${x}" y="${y}" width="1" height="1" opacity="${
                        pixel.o
                    }" ${fillAttr} />`;
                });
                const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${SIZE} ${SIZE}" shape-rendering="crispEdges">
            <style>
                .themable { fill: ${cLight}; }
                @media (prefers-color-scheme: dark) {
                    .themable { fill: ${cDark}; } 
                }
                /* Custom text color checks */
                text { fill: black; font-weight: 900; pointer-events: none; }
                @media (prefers-color-scheme: dark) { text { fill: white; } }
            </style>
            ${rects}
            <text x="2.5" y="3.5" text-anchor="middle" font-family="monospace" font-size="3px"></text>
        </svg>`;
                // 4. Inject
                const link = document.createElement('link');
                link.rel = 'icon';
                link.id = 'dynamic-favicon'; // ID for easier updates later
                link.href = 'data:image/svg+xml,' + encodeURIComponent(svg);
                document.head.appendChild(link);
                // Expose for the editor to use
                window.BodgeIdentity = {
                    data: identity,
                    save: (newData) => {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
                        // Reload page to apply? Or we can just update the link tag logic here. For simplicity in the editor, we'll let the
                        // editor handle the live update.
                    }
                };
            })();
        </script>
        <link href="/css/prism.css" rel="stylesheet"/>
        <link rel="stylesheet" href="/css/main.css">
        <script src="/js/theme.js"></script>
        <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <meta charset="UTF-8">
        <title>{{ seo.title }}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="{{ seo.description }}">
        <meta name="generator" content="{{ eleventy.generator }}">
        <meta property="og:site_name" content="{{ meta.siteName or 'The Bodge Lab' }}">
        <meta property="og:type" content="{{ seo.type }}">
        <meta property="og:url" content="{{ seo.url }}">
        <link rel="canonical" href="{{ seo.url }}">
        <meta property="og:title" content="{{ seo.title }}">
        <meta property="og:description" content="{{ seo.description }}">
        {% if seo.image %}
            <meta property="og:image" content="{{ seo.image }}">
        {% endif %}
        {# --- MEDIA TAGS --- #}
        {# MEDIA TAGS: prefer embedUrl for player/video tags when available #}
        {% if seo.media %}
            {% if seo.media.type == 'video' %}
                {# Video Tags: use embedUrl when present (YouTube embed or local player) #}
                {% if seo.media.embedUrl %}
                    <meta property="og:video" content="{{ seo.media.embedUrl }}">
                    <meta property="og:video:secure_url" content="{{ seo.media.embedUrl }}">
                {% else %}
                    <meta property="og:video" content="{{ seo.media.url }}">
                    <meta property="og:video:secure_url" content="{{ seo.media.secure_url }}">
                {% endif %}
                <meta property="og:video:type" content="{{ seo.media.mime }}">
                {% if seo.media.width %}<meta property="og:video:width" content="{{ seo.media.width }}">{% endif %}
                {% if seo.media.height %}<meta property="og:video:height" content="{{ seo.media.height }}">{% endif %}
            {% elif seo.media.type == 'audio' %}
                {# Audio Tags #}
                <meta property="og:audio" content="{{ seo.media.url }}">
                <meta property="og:audio:secure_url" content="{{ seo.media.secure_url }}">
                <meta property="og:audio:type" content="{{ seo.media.mime }}">
            {% endif %}
        {% endif %}

        {# Twitter card: use player only for YouTube embeds (broad compatibility). Otherwise use summary_large_image. #}
        {% if seo.media and seo.media.isYouTube and seo.media.embedUrl %}
            <meta name="twitter:card" content="player">
            <meta name="twitter:player" content="{{ seo.media.embedUrl }}">
            <meta name="twitter:player:width" content="{{ seo.media.width or 1280 }}">
            <meta name="twitter:player:height" content="{{ seo.media.height or 720 }}">
        {% else %}
            <meta name="twitter:card" content="summary_large_image">
        {% endif %}
        {% if seo.image %}
            <meta name="twitter:image" content="{{ seo.image }}">
        {% endif %}
    </head>
    <body>
        <header>
            <nav class="nav-container">
                <div class="breadcrumb-nav">
                    <span class="separator">\\</span>
                    <a href="/" class="breadcrumb" title="Home Directory">BodgeLab</a>
                    {% set url_parts = page.url | split('/') %}
                    {% set accumulated_path = '' %}
                    {% for part in url_parts %}
                        {% if part and part != 'index.html' %}
                            {% set accumulated_path = accumulated_path + '/' + part %}
                            <span class="separator">\</span>
                            {% if not loop.last %}
                                <a href="{{ accumulated_path }}/" class="breadcrumb">{{ part }}</a>
                            {% else %}
                                <span class="current">{{ title if title and title != "Home" else part }}</span>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                <div
                    class="page-nav">
                    {# Right Side: Parent Link #}
                    {% if parentUrl %}
                        <div>
                            <a href="{{ parentUrl }}" class="nav-link up">⇱ Go Up</a>
                        </div>
                    {% endif %}
                    {# Left Side: Date #}
                    {% if page.date and page.url != "/" %}
                        <div class="page-meta-date">
                            <i>
                                <em>Modified: {{ page.date | readableDate }}</em>
                            </i>
                        </div>
                    {% endif %}
                </div>
            </nav>
        </header>
        {% if content or media %}
            <main class="main-content">
                {% block content %}
                    {{ content | safe }}
                {% endblock %}
                {% if download %}
                    <div class="page-meta">
                        {% set download_href = "" %}
                        {% if media and media.url %}
                            {# This is a media page. Use the media.url (e.g., /Bug & Moss/logo.jpg) #}
                            {% set download_href = media.url %}
                        {% else %}
                            {# This is a post page. Use the page.inputPath (e.g., /posts/firstpost.md) #}
                            {#{% set download_href = "data:text/markdown;charset=utf-8," + page.inputContent | urlencode %}#}
                        {% set download_href = "data:application/octet-stream;charset=utf-8," + (page.rawInput | urlencode) %}
                        {% endif %}
                        <hr>
                            <p class="download-btn-container"> <a class="page-share-btn" href="/s/{{ uid }}/" title="Get permanent link">
                                SHARE⇗
                            </a>
                            <a class="page-download-btn nowrap" href="{{ download_href | safe }}" download="{{ download_filename | safe }}" title='Download "{{ download_filename | safe }}"'>
                                DOWNLOAD POST ⤓
                            </a>
                        </p>
                    </div>
                {% endif %}
            </main>
            <br>
        {% endif %}
        {# --- DIRECTORY LISTING SECTION --- #}
        {% if directory %}
            {% set hasDirs = directoryContents.directories | length > 0 %}
            {% set hasPages = directoryContents.pages | length > 0 %}
            {% set hasFiles = directoryContents.files | length > 0 %}
            {% set hasContent = hasDirs or hasPages or hasFiles %}
            {% if hasContent %}
                <section class="directory-container">
                    <div class="directory-header">
                        {% if directoryParentUrl %}
                            <a href="{{ directoryParentUrl }}" class="nav-link-small up">..\
                            </a>
                        {% endif %}
                        <h3 class="directory-title">{{ directoryTitle | safe }}</h3>
                    </div>
                    {# 2. Directory Contents Listing #}
                    {% if directoryContents %}
                        <ul class="dir-listing">
                            {% for dir in directoryContents.directories %}
                                <li>
                                    <span
                                        class="icon"
                                        style="-webkit-mask-image: url('/.config/foldericon.svg'); mask-image: url('/.config/foldericon.svg');"></span>
                                    <a href="{{ dir.url }}">{{ dir.name }}\</a>
                                </li>
                            {% endfor %}
                            {% for item in directoryContents.pages %}
                                <li>
                                    <span class="icon" style="-webkit-mask-image: url('/.config/pageicon.svg'); mask-image: url('/.config/pageicon.svg');"></span>
                                    {% if item.isCurrent %}
                                        {# It's the current page, so make it bold and not a link #}
                                        <strong>{{ item.name }}</strong>
                                    {% else %}
                                        {# It's not the current page, so make it a normal link #}
                                        <a href="{{ item.url }}">{{ item.name }}</a>
                                    {% endif %}
                                </li>
                            {% endfor %}
                            {% for file in directoryContents.files %}
                                <li>
                                    <span class="icon" style="-webkit-mask-image: url('/.config/fileicon.svg'); mask-image: url('/.config/fileicon.svg');"></span>
                                    <a class="nowrap" href="{{ file.url }}">{{ file.name }}</a>
                                    <a href="{{ file.downloadUrl }}" download class="dir-download-icon" title="Download {{ file.name }}"></a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </section>
                <div class="site-options-row">
                    <button id="theme-toggle" class="theme-toggle">Dark Mode</button>
                </div>
            {% endif %}
        {% endif %}
        {% if uid %}
            <script>/*
                // REPLACE URL IN BAR WITH SHARELINK
                (function () { // 1. This is the "permanent" URL
                    const permanentUrl = "/s/{{ uid }}/";
                    // 2. This is the URL we are currently at
                    const currentPath = window.location.pathname;
                    // 3. If we're not already on the permanent URL...
                    if (currentPath !== permanentUrl) {
                        // ...replace the history state. This changes the URL in the bar without reloading the page or breaking the back
                        // button.
                        history.replaceState(null, "", permanentUrl);
                    }
                })();
                // */</script>
    {% endif %}
    <script src="/js/main.js"></script>
</body></html></body></html>