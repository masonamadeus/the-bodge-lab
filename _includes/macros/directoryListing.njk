{% macro listFiles(collectionsAll, currentPage) %}

{% set currentDir = currentPage.inputPath | dirname %}

{% set directories = [] %}
{% set files = [] %}

{% for item in collectionsAll %}
  {% set itemDir = item.inputPath | dirname %}
  {% set itemBase = item.inputPath | basename %}

  {# Case 1: It's an index page for a *subdirectory* of the current page #}
  {% if (itemDir | dirname) == currentDir and (itemBase == 'index.md' or itemBase == 'index.njk') %}
    {% set directories = directories.concat([item]) %}
  
  {# Case 2: It's a content page *inside* the current directory #}
  {% elif itemDir == currentDir and item.inputPath != currentPage.inputPath and not (itemBase == 'index.md' or itemBase == 'index.njk') %}
    {% set files = files.concat([item]) %}
  {% endif %}
{% endfor %}

<ul class="dir-listing">
  {# Loop over the unique directory names we found #}
  {% for item in directories | sortBy('data.title') %}
    <li>
      <span>üìÅ</span>
      {# Use title, or fall back to the directory name itself #}
      {% set dirName = (item.inputPath | dirname | basename) %}
      <a href="{{ item.url }}">{{ item.data.title or dirName }}/</a>
    </li>
  {% endfor %}

  {# Loop over the direct child files we found #}
  {% for item in files | sortBy('data.title') %}
    <li>
      <span>üìÑ</span>
      {# Use title, or fall back to the file's slug #}
      <a href="{{ item.url }}">{{ item.data.title or item.fileSlug }}</a>
    </li>
  {% endfor %}
</ul>
{% endmacro %}